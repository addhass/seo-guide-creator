<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Guide Creator - Live System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card, .test-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .status-item:hover {
            background: #e9ecef;
        }
        
        .status-label {
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .status-indicator.success { 
            background: #28a745; 
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }
        .status-indicator.error { 
            background: #dc3545; 
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }
        .status-indicator.warning { 
            background: #ffc107; 
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2);
        }
        .status-indicator.loading { 
            background: #17a2b8; 
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.2);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover:not(:disabled) {
            background: #545b62;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover:not(:disabled) {
            background: #218838;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-input {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .test-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 4px 0;
        }
        
        .log-entry.info { color: #58a6ff; }
        .log-entry.success { color: #56d364; }
        .log-entry.error { color: #f85149; }
        .log-entry.warning { color: #d29922; }
        
        .results-area {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: #495057;
            margin-right: 8px;
        }
        
        .user-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 20px;
        }
        
        .user-info-card .status-item {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .user-info-card .status-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .user-info-card .status-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .file-upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        
        .file-upload-area:hover {
            border-color: #007bff;
            background: #f0f7ff;
        }
        
        .file-upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: #e9ecef;
            color: #495057;
        }
        
        .badge.success { background: #d4edda; color: #155724; }
        .badge.error { background: #f8d7da; color: #721c24; }
        .badge.warning { background: #fff3cd; color: #856404; }
        
        /* Admin bar styles */
        #adminBar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 35px;
            background: #FFA500;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #adminBar button, #adminBar a {
            background: white;
            color: #FFA500;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            min-width: 150px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        #adminBar button:hover, #adminBar a:hover {
            background: #f0f0f0;
        }
        
        /* Adjust body padding when admin bar is shown */
        body.admin-mode {
            padding-top: 35px;
        }
    </style>
</head>
<body>
    <h1>🚀 SEO Guide Creator - Live System Test</h1>
    
    <!-- Admin Bar will be inserted here by JavaScript -->
    
    <!-- User Info Card -->
    <div class="status-card user-info-card" id="userInfoCard" style="display: none;">
        <div class="card-header">
            <h2 class="card-title">User Information</h2>
            <button onclick="logout()" class="secondary">Logout</button>
        </div>
        <div class="status-item">
            <span class="status-label">Email</span>
            <span id="userEmail">-</span>
        </div>
        <div class="status-item">
            <span class="status-label">Session Status</span>
            <span id="sessionStatus">-</span>
        </div>
    </div>
    
    <div class="test-grid">
        <!-- System Status Card -->
        <div class="status-card">
            <div class="card-header">
                <h2 class="card-title">System Status</h2>
                <button onclick="refreshStatus()" class="secondary">
                    <span id="refreshIcon">↻</span> Refresh
                </button>
            </div>
            <div class="status-item">
                <span class="status-label">Server Health</span>
                <div class="status-indicator loading" id="server-status">⏳</div>
            </div>
            <div class="status-item">
                <span class="status-label">Authentication</span>
                <div class="status-indicator loading" id="auth-status">⏳</div>
            </div>
            <div class="status-item">
                <span class="status-label">DataForSEO API</span>
                <div class="status-indicator loading" id="dataforseo-status">⏳</div>
            </div>
            <div class="status-item">
                <span class="status-label">Anthropic API</span>
                <div class="status-indicator loading" id="anthropic-status">⏳</div>
            </div>
        </div>
        
        <!-- Test Configuration -->
        <div class="test-card">
            <h2 class="card-title">Test Configuration</h2>
            <label for="serverUrl" style="font-size: 14px; color: #666; margin-bottom: 4px; display: block;">Server URL</label>
            <input type="text" class="test-input" id="serverUrl" value="https://seo-guide-creator-api.vercel.app" />
            
            <label for="testDomain" style="font-size: 14px; color: #666; margin-bottom: 4px; display: block;">Test Domain</label>
            <input type="text" class="test-input" id="testDomain" value="wilddonkeycompany.com" />
            
            <label for="testAboutUrl" style="font-size: 14px; color: #666; margin-bottom: 4px; display: block;">Test About URL</label>
            <input type="text" class="test-input" id="testAboutUrl" value="https://wilddonkeycompany.com/pages/about-us" />
            
            <div class="test-controls" style="margin-top: 16px;">
                <button onclick="runAllTests()" class="success">
                    ▶️ Run All Tests
                </button>
                <button onclick="clearLogs()" class="secondary">
                    🗑️ Clear Logs
                </button>
            </div>
        </div>
    </div>
    
    <div class="test-grid">
        <!-- File Processing Test -->
        <div class="test-card">
            <div class="card-header">
                <h2 class="card-title">📄 File Processing</h2>
                <span class="badge" id="file-test-badge">Ready</span>
            </div>
            <div class="file-upload-area" onclick="document.getElementById('testFile').click()" id="fileDropArea">
                <p>📁 Click or drag TSV/CSV file here</p>
                <p style="font-size: 12px; color: #666;">Supports "Search Volume (MSV)" format</p>
            </div>
            <input type="file" id="testFile" accept=".csv,.tsv" onchange="handleFileSelect(event)" />
            <div class="test-controls">
                <button onclick="testFileProcessing()" id="fileTestBtn">
                    🧪 Test File Processing
                </button>
            </div>
            <div class="results-area" id="fileResults" style="display: none;"></div>
        </div>
        
        <!-- Competitor Discovery Test -->
        <div class="test-card">
            <div class="card-header">
                <h2 class="card-title">🔍 Competitor Discovery</h2>
                <span class="badge" id="competitor-test-badge">Ready</span>
            </div>
            <input type="text" class="test-input" id="testKeywords" placeholder="Enter test keywords (comma separated)" value="vintage sweatshirts, mens sweatshirts, unisex sweatshirts" />
            <div class="test-controls">
                <button onclick="testCompetitorDiscovery()" id="competitorTestBtn">
                    🧪 Test Discovery
                </button>
            </div>
            <div class="results-area" id="competitorResults" style="display: none;"></div>
        </div>
        
        <!-- About Us Analysis Test -->
        <div class="test-card">
            <div class="card-header">
                <h2 class="card-title">🤖 About Us Analysis</h2>
                <span class="badge" id="about-test-badge">Ready</span>
            </div>
            <div class="test-controls">
                <button onclick="testAboutUsAnalysis()" id="aboutTestBtn">
                    🧪 Test Analysis
                </button>
            </div>
            <div class="results-area" id="aboutResults" style="display: none;"></div>
        </div>
        
        <!-- Product Analysis Test -->
        <div class="test-card">
            <div class="card-header">
                <h2 class="card-title">📦 Product Analysis</h2>
                <span class="badge" id="product-test-badge">Ready</span>
            </div>
            <div class="test-controls">
                <button onclick="testProductAnalysis()" id="productTestBtn">
                    🧪 Test Analysis
                </button>
            </div>
            <div class="results-area" id="productResults" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Test Logs -->
    <div class="status-card">
        <div class="card-header">
            <h2 class="card-title">📋 Test Logs</h2>
            <button onclick="copyLogs()" class="secondary">
                📋 Copy Logs
            </button>
        </div>
        <div class="log-area" id="logArea"></div>
    </div>
    
    <!-- Scripts -->
    <!-- Cache Buster - MUST BE FIRST -->
    <script src="js/cache-buster.js?v=2.9"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js?v=2.9"></script>
    <script src="js/supabase-client.js?v=2.9"></script>
    <script src="js/auth-helper.js?v=2.9"></script>
    
    <script>
        let supabaseInstance = null;
        let currentUser = null;
        let testFile = null;
        
        // Logging functions
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        // Copy logs to clipboard
        function copyLogs(event) {
            const logArea = document.getElementById('logArea');
            const logEntries = Array.from(logArea.querySelectorAll('.log-entry'));
            
            if (logEntries.length === 0) {
                log('No logs to copy', 'warning');
                return;
            }
            
            // Convert log entries to plain text
            const logText = logEntries.map(entry => entry.textContent).join('\n');
            
            // Create a formatted report
            const report = `SEO Guide Creator - System Test Report
Generated: ${new Date().toLocaleString()}
User: ${currentUser?.email || 'Not authenticated'}

=== Test Results ===
${logText}

=== System Status ===
Server: ${document.getElementById('server-status').className.includes('success') ? '✅ Online' : '❌ Offline'}
Auth: ${document.getElementById('auth-status').className.includes('success') ? '✅ Authenticated' : '❌ Not authenticated'}
DataForSEO: ${document.getElementById('dataforseo-status').className.includes('success') ? '✅ Configured' : '⚠️ Not configured'}
Anthropic: ${document.getElementById('anthropic-status').className.includes('success') ? '✅ Configured' : '⚠️ Not configured'}

=== Configuration ===
Server URL: ${document.getElementById('serverUrl').value}
Test Domain: ${document.getElementById('testDomain').value}
Test About URL: ${document.getElementById('testAboutUrl').value}
`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                log('✅ Logs copied to clipboard', 'success');
                
                // Visual feedback
                const btn = document.querySelector('button[onclick*="copyLogs"]');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }
            }).catch(err => {
                log('Failed to copy logs: ' + err.message, 'error');
            });
        }
        
        function setStatus(id, status, message = '') {
            const element = document.getElementById(id);
            element.className = `status-indicator ${status}`;
            element.textContent = status === 'success' ? '✓' : 
                               status === 'error' ? '✗' : 
                               status === 'warning' ? '!' : '⏳';
            if (message) element.title = message;
        }
        
        function setBadge(id, status, text) {
            const badge = document.getElementById(id);
            badge.className = `badge ${status}`;
            badge.textContent = text;
        }
        
        // Initialize authentication
        async function initAuth() {
            try {
                log('Initializing authentication...', 'info');
                
                // Initialize Supabase client directly
                const SUPABASE_URL = 'https://jdqdfejuesqbcxjwbcwl.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkcWRmZWp1ZXNxYmN4andiY3dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjQyNjgsImV4cCI6MjA2ODYwMDI2OH0._co76nJaxBJDKN25wpbbTMJE5QEY3wsQ-1H9MvrMXGs';
                
                supabaseInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Initialize supabaseClient module if available
                if (window.supabaseClient && window.supabaseClient.init) {
                    await window.supabaseClient.init();
                }
                
                // Get current session
                const { data: { session }, error } = await supabaseInstance.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                if (session && session.user) {
                    currentUser = session.user;
                    log(`Authenticated as ${currentUser.email}`, 'success');
                    
                    // Show user info
                    document.getElementById('userInfoCard').style.display = 'block';
                    document.getElementById('userEmail').textContent = currentUser.email;
                    document.getElementById('sessionStatus').textContent = 'Active';
                    
                    // Show admin bar if this is the admin user
                    if (currentUser.email === 'addam@addhass.com') {
                        showAdminBar();
                    }
                    
                    setStatus('auth-status', 'success', 'Authenticated');
                    return true;
                } else {
                    log('Not authenticated. Redirecting to login page...', 'warning');
                    setStatus('auth-status', 'error', 'Not authenticated');
                    
                    // Show login button in user info card
                    document.getElementById('userInfoCard').style.display = 'block';
                    document.getElementById('userEmail').textContent = 'Not logged in';
                    document.getElementById('sessionStatus').innerHTML = '<a href="auth.html" style="padding: 6px 12px; font-size: 14px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; display: inline-block;">Go to Login</a>';
                    
                    return false;
                }
            } catch (error) {
                log(`Auth initialization failed: ${error.message}`, 'error');
                setStatus('auth-status', 'error', error.message);
                return false;
            }
        }
        
        // Show admin bar for admin user
        function showAdminBar() {
            log('Showing admin bar for admin user', 'info');
            
            // Add body padding
            document.body.classList.add('admin-mode');
            
            // Create admin bar if it doesn't exist
            let adminBar = document.getElementById('adminBar');
            if (!adminBar) {
                adminBar = document.createElement('div');
                adminBar.id = 'adminBar';
                adminBar.innerHTML = `
                    <span>🔧 Admin Mode</span>
                    <a href="index.html">🏠 Homepage</a>
                    <button id="adminPrefillBtn">Prefill Wild Donkey</button>
                    <button id="adminLoadKeywordsBtn">Load Keywords</button>
                    <a href="product-guide-builder-modular.html">📝 Main App</a>
                `;
                
                document.body.insertBefore(adminBar, document.body.firstChild);
                
                // Setup button handlers
                document.getElementById('adminPrefillBtn').onclick = () => {
                    document.getElementById('testDomain').value = 'wilddonkeycompany.com';
                    document.getElementById('testAboutUrl').value = 'https://wilddonkeycompany.com/pages/about-us';
                    document.getElementById('testKeywords').value = 'vintage sweatshirts, mens sweatshirts, unisex sweatshirts';
                    log('✅ Wild Donkey test data loaded', 'success');
                };
                
                document.getElementById('adminLoadKeywordsBtn').onclick = () => {
                    document.getElementById('testKeywords').value = 'vintage sweatshirts, mens sweatshirts, unisex sweatshirts, graphic sweatshirts, retro sweatshirts';
                    log('✅ Keywords loaded', 'success');
                };
            }
        }
        
        // Get auth token
        async function getAuthToken() {
            try {
                const { data: { session } } = await supabaseInstance.auth.getSession();
                return session?.access_token || null;
            } catch (error) {
                log(`Failed to get auth token: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Logout function
        async function logout() {
            try {
                await supabaseInstance.auth.signOut();
                window.location.reload();
            } catch (error) {
                log(`Logout failed: ${error.message}`, 'error');
            }
        }
        
        
        // Test server health
        async function testServerHealth() {
            log('Testing server health...', 'info');
            setStatus('server-status', 'loading');
            
            const serverUrl = document.getElementById('serverUrl').value;
            
            try {
                const response = await fetch(`${serverUrl}/health`);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    setStatus('server-status', 'success', 'Server is healthy');
                    log('✅ Server is healthy', 'success');
                    return true;
                } else {
                    setStatus('server-status', 'error', 'Server health check failed');
                    log('❌ Server health check failed', 'error');
                    return false;
                }
            } catch (error) {
                setStatus('server-status', 'error', error.message);
                log(`❌ Server error: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Check API keys
        async function checkApiKeys() {
            try {
                if (!window.supabaseClient || !window.supabaseClient.apiKeys) {
                    log('API keys module not available', 'warning');
                    return;
                }
                
                const keys = await window.supabaseClient.apiKeys.getAll();
                
                if (keys.data) {
                    const hasDataForSEO = keys.data.some(k => k.service === 'dataforseo');
                    const hasAnthropic = keys.data.some(k => k.service === 'anthropic');
                    
                    setStatus('dataforseo-status', hasDataForSEO ? 'success' : 'warning', 
                        hasDataForSEO ? 'Key configured' : 'No key found');
                    setStatus('anthropic-status', hasAnthropic ? 'success' : 'warning',
                        hasAnthropic ? 'Key configured' : 'No key found');
                    
                    log(`DataForSEO: ${hasDataForSEO ? '✅ Configured' : '⚠️ Not configured'}`, 
                        hasDataForSEO ? 'success' : 'warning');
                    log(`Anthropic: ${hasAnthropic ? '✅ Configured' : '⚠️ Not configured'}`, 
                        hasAnthropic ? 'success' : 'warning');
                }
            } catch (error) {
                log(`Failed to check API keys: ${error.message}`, 'error');
            }
        }
        
        // Refresh all status
        async function refreshStatus() {
            document.getElementById('refreshIcon').style.animation = 'spin 1s linear';
            
            await testServerHealth();
            await initAuth();
            await checkApiKeys();
            
            setTimeout(() => {
                document.getElementById('refreshIcon').style.animation = '';
            }, 1000);
        }
        
        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                testFile = file;
                document.getElementById('fileDropArea').innerHTML = `
                    <p>📄 ${file.name}</p>
                    <p style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</p>
                `;
                setBadge('file-test-badge', '', 'File loaded');
            }
        }
        
        // File drop handling
        const fileDropArea = document.getElementById('fileDropArea');
        
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('dragover');
        });
        
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('dragover');
        });
        
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.csv') || file.name.endsWith('.tsv'))) {
                testFile = file;
                document.getElementById('fileDropArea').innerHTML = `
                    <p>📄 ${file.name}</p>
                    <p style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</p>
                `;
                setBadge('file-test-badge', '', 'File loaded');
            }
        });
        
        // Test file processing
        async function testFileProcessing() {
            if (!testFile) {
                log('Please select a CSV or TSV file first', 'warning');
                return;
            }
            
            setBadge('file-test-badge', 'warning', 'Testing...');
            log(`Testing file: ${testFile.name}`, 'info');
            
            try {
                const content = await testFile.text();
                const lines = content.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('File must have header and data rows');
                }
                
                // Detect delimiter
                const delimiter = content.includes('\t') ? '\t' : ',';
                const fileType = delimiter === '\t' ? 'TSV' : 'CSV';
                
                // Parse headers
                const headers = lines[0].split(delimiter).map(h => h.trim());
                log(`Detected ${fileType} file with ${headers.length} columns`, 'info');
                
                // Check for required columns
                const keywordCol = headers.find(h => 
                    h.toLowerCase() === 'keyword' || h.toLowerCase() === 'primary keyword'
                );
                const searchVolumeCol = headers.find(h => {
                    const normalized = h.toLowerCase();
                    return (normalized.includes('search') && normalized.includes('volume')) || 
                           normalized.includes('msv');
                });
                
                const results = document.getElementById('fileResults');
                results.style.display = 'block';
                results.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">File Type:</span> ${fileType}
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total Rows:</span> ${lines.length - 1}
                    </div>
                    <div class="result-item">
                        <span class="result-label">Keyword Column:</span> 
                        ${keywordCol ? `✅ "${keywordCol}"` : '❌ Not found'}
                    </div>
                    <div class="result-item">
                        <span class="result-label">Search Volume Column:</span> 
                        ${searchVolumeCol ? `✅ "${searchVolumeCol}"` : '❌ Not found'}
                    </div>
                `;
                
                if (keywordCol && searchVolumeCol) {
                    log('✅ File structure validated successfully', 'success');
                    setBadge('file-test-badge', 'success', 'Valid');
                    
                    // Show sample keywords
                    const keywordIndex = headers.indexOf(keywordCol);
                    const sampleKeywords = lines.slice(1, 4)
                        .map(line => line.split(delimiter)[keywordIndex])
                        .filter(k => k);
                    
                    if (sampleKeywords.length > 0) {
                        results.innerHTML += `
                            <div class="result-item">
                                <span class="result-label">Sample Keywords:</span>
                                ${sampleKeywords.join(', ')}
                            </div>
                        `;
                    }
                } else {
                    log('❌ Required columns not found', 'error');
                    setBadge('file-test-badge', 'error', 'Invalid');
                }
                
            } catch (error) {
                log(`File test error: ${error.message}`, 'error');
                setBadge('file-test-badge', 'error', 'Error');
            }
        }
        
        // Test competitor discovery
        async function testCompetitorDiscovery() {
            const token = await getAuthToken();
            if (!token) {
                log('Authentication required for this test', 'error');
                return;
            }
            
            setBadge('competitor-test-badge', 'warning', 'Testing...');
            const btn = document.getElementById('competitorTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Testing...';
            
            const serverUrl = document.getElementById('serverUrl').value;
            const keywords = document.getElementById('testKeywords').value.split(',').map(k => k.trim());
            
            try {
                log(`Testing competitor discovery with keywords: ${keywords.join(', ')}`, 'info');
                
                const response = await fetch(`${serverUrl}/get-serp-competitors-sequential`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        location: 'United States'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMsg;
                    try {
                        const errorObj = JSON.parse(errorText);
                        errorMsg = errorObj.error || errorObj.message || errorText;
                    } catch {
                        errorMsg = errorText;
                    }
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                log(`✅ Found ${data.uniqueCompetitors?.length || 0} competitors`, 'success');
                setBadge('competitor-test-badge', 'success', 'Success');
                
                const results = document.getElementById('competitorResults');
                results.style.display = 'block';
                
                if (data.uniqueCompetitors && data.uniqueCompetitors.length > 0) {
                    results.innerHTML = `
                        <h4>Top Competitors:</h4>
                        ${data.uniqueCompetitors.slice(0, 5).map((c, i) => `
                            <div class="result-item">
                                ${i + 1}. <strong>${c.domain}</strong>
                                <span style="float: right;">Score: ${c.relevanceScore?.toFixed(2) || 'N/A'}</span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    results.innerHTML = '<p>No competitors found</p>';
                }
                
            } catch (error) {
                log(`Competitor test error: ${error.message}`, 'error');
                setBadge('competitor-test-badge', 'error', 'Failed');
                
                // Display error details
                const results = document.getElementById('competitorResults');
                results.style.display = 'block';
                results.innerHTML = `
                    <h4 style="color: #dc3545;">Error Details:</h4>
                    <div class="result-item" style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                        <p><strong>Error:</strong> ${error.message}</p>
                        ${error.message.includes('DataForSEO') ? `
                            <p style="margin-top: 10px;"><strong>Solution:</strong></p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Go to your Vercel dashboard</li>
                                <li>Navigate to Settings → Environment Variables</li>
                                <li>Add these variables:
                                    <ul style="margin-top: 5px;">
                                        <li><code>DATAFORSEO_LOGIN</code> = your DataForSEO username</li>
                                        <li><code>DATAFORSEO_PASSWORD</code> = your DataForSEO password</li>
                                    </ul>
                                </li>
                                <li>Redeploy your application</li>
                            </ol>
                        ` : ''}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🧪 Test Discovery';
            }
        }
        
        // Test About Us analysis
        async function testAboutUsAnalysis() {
            const token = await getAuthToken();
            if (!token) {
                log('Authentication required for this test', 'error');
                return;
            }
            
            setBadge('about-test-badge', 'warning', 'Testing...');
            const btn = document.getElementById('aboutTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Testing...';
            
            const serverUrl = document.getElementById('serverUrl').value;
            const aboutUrl = document.getElementById('testAboutUrl').value;
            
            try {
                log(`Fetching About Us page: ${aboutUrl}`, 'info');
                
                // Fetch page content
                const fetchResponse = await fetch(`${serverUrl}/fetch-page?url=${encodeURIComponent(aboutUrl)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!fetchResponse.ok) {
                    throw new Error('Failed to fetch About Us page');
                }
                
                const pageData = await fetchResponse.json();
                log('✅ Page fetched successfully', 'success');
                
                // Analyze with Claude
                log('Analyzing with Claude API...', 'info');
                const analyzeResponse = await fetch(`${serverUrl}/claude-api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: `Based on this About Us content, provide:
1. A unique selling proposition (USP) in 1-2 sentences
2. Target audience description in 1 sentence

Content: ${pageData.text?.substring(0, 2000)}`
                        }],
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 200
                    })
                });
                
                if (!analyzeResponse.ok) {
                    const error = await analyzeResponse.text();
                    throw new Error(`Claude API failed: ${error}`);
                }
                
                const result = await analyzeResponse.json();
                log('✅ Analysis completed', 'success');
                log(`Response structure: ${JSON.stringify(Object.keys(result))}`, 'info');
                
                const results = document.getElementById('aboutResults');
                results.style.display = 'block';
                
                // Handle different response formats
                let analysisText = 'No analysis generated';
                
                // Check if the response has success/data structure
                if (result.success && result.data) {
                    // Extract text from the data object
                    if (result.data.content && Array.isArray(result.data.content) && result.data.content[0]?.text) {
                        analysisText = result.data.content[0].text;
                    } else if (result.data.content && typeof result.data.content === 'string') {
                        analysisText = result.data.content;
                    } else if (result.data.message) {
                        analysisText = result.data.message;
                    } else if (typeof result.data === 'string') {
                        analysisText = result.data;
                    }
                } else if (result.content && Array.isArray(result.content) && result.content[0]?.text) {
                    analysisText = result.content[0].text;
                } else if (result.content && typeof result.content === 'string') {
                    analysisText = result.content;
                } else if (result.message) {
                    analysisText = result.message;
                }
                
                if (analysisText !== 'No analysis generated') {
                    setBadge('about-test-badge', 'success', 'Success');
                    results.innerHTML = `
                        <h4>Generated Analysis:</h4>
                        <div class="result-item" style="white-space: pre-wrap;">
                            ${analysisText}
                        </div>
                    `;
                } else {
                    setBadge('about-test-badge', 'error', 'No Content');
                    results.innerHTML = `
                        <h4>Error: No analysis content found</h4>
                        <div class="result-item">
                            <p>Response structure: ${JSON.stringify(result, null, 2)}</p>
                        </div>
                    `;
                    log('⚠️ No analysis content found in response', 'warning');
                }
                
            } catch (error) {
                log(`About Us test error: ${error.message}`, 'error');
                setBadge('about-test-badge', 'error', 'Failed');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🧪 Test Analysis';
            }
        }
        
        // Test product analysis
        async function testProductAnalysis() {
            const token = await getAuthToken();
            if (!token) {
                log('Authentication required for this test', 'error');
                return;
            }
            
            setBadge('product-test-badge', 'warning', 'Testing...');
            const btn = document.getElementById('productTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Testing...';
            
            const serverUrl = document.getElementById('serverUrl').value;
            const testDomain = document.getElementById('testDomain').value;
            
            try {
                log(`Testing product analysis for: ${testDomain}`, 'info');
                
                const response = await fetch(`${serverUrl}/analyze-competitor-products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        domain: testDomain
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                
                const data = await response.json();
                log('✅ Product analysis completed', 'success');
                setBadge('product-test-badge', 'success', 'Success');
                
                const results = document.getElementById('productResults');
                results.style.display = 'block';
                results.innerHTML = `
                    <div class="result-item">
                        <span class="result-label">Platform:</span> 
                        ${data.platform || 'Unknown'}
                    </div>
                    <div class="result-item">
                        <span class="result-label">Products Found:</span> 
                        ${data.products?.length || 0}
                    </div>
                    ${data.products && data.products.length > 0 ? `
                        <div class="result-item">
                            <span class="result-label">Sample Product:</span>
                            ${data.products[0].title || 'N/A'}
                        </div>
                        <div class="result-item">
                            <span class="result-label">Description Length:</span>
                            ${data.products[0].description?.length || 0} chars
                        </div>
                    ` : ''}
                `;
                
            } catch (error) {
                log(`Product test error: ${error.message}`, 'error');
                setBadge('product-test-badge', 'error', 'Failed');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🧪 Test Analysis';
            }
        }
        
        // Run all tests
        async function runAllTests() {
            log('Starting complete system test...', 'info');
            
            // Check authentication first
            const isAuth = await initAuth();
            if (!isAuth) {
                log('Please login first to run tests', 'error');
                if (confirm('You need to be logged in to run tests. Click OK to go to the login page.')) {
                    window.location.href = 'auth.html';
                }
                return;
            }
            
            // Run tests in sequence
            await testServerHealth();
            await checkApiKeys();
            
            // Run feature tests with delays
            setTimeout(() => {
                if (testFile) testFileProcessing();
            }, 500);
            
            setTimeout(() => {
                testCompetitorDiscovery();
            }, 1000);
            
            setTimeout(() => {
                testAboutUsAnalysis();
            }, 1500);
            
            setTimeout(() => {
                testProductAnalysis();
            }, 2000);
            
            // Show summary after all tests
            setTimeout(() => {
                log('=== TEST SUMMARY ===', 'info');
                const competitorBadge = document.getElementById('competitor-test-badge').textContent;
                const aboutBadge = document.getElementById('about-test-badge').textContent;
                const productBadge = document.getElementById('product-test-badge').textContent;
                
                let passedTests = 0;
                let failedTests = 0;
                
                if (competitorBadge === 'Success') passedTests++;
                else if (competitorBadge === 'Failed') failedTests++;
                
                if (aboutBadge === 'Success') passedTests++;
                else if (aboutBadge === 'Failed' || aboutBadge === 'No Content') failedTests++;
                
                if (productBadge === 'Success') passedTests++;
                else if (productBadge === 'Failed') failedTests++;
                
                log(`Tests Passed: ${passedTests} | Tests Failed: ${failedTests}`, 
                    failedTests > 0 ? 'warning' : 'success');
                
                if (failedTests > 0) {
                    log('Check the individual test results above for error details and solutions.', 'info');
                }
            }, 3000);
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', async () => {
            log('Initializing test suite...', 'info');
            
            // First check server
            await testServerHealth();
            
            // Add a small delay to ensure Supabase is fully loaded
            setTimeout(async () => {
                const isAuth = await initAuth();
                if (isAuth) {
                    await checkApiKeys();
                } else {
                    // Try one more time in case of timing issues
                    setTimeout(async () => {
                        const retryAuth = await initAuth();
                        if (retryAuth) {
                            await checkApiKeys();
                        }
                    }, 1000);
                }
            }, 500);
        });
    </script>
</body>
</html>